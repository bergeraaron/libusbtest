#include <stdbool.h>
#include <time.h>
#include <stdlib.h>
#include <stdio.h>
#include <string.h>
#include <signal.h>
#include <assert.h>
#include <unistd.h>
#include <pthread.h>
#include <libusb-1.0/libusb.h>

#define BLE_VIEWTOOL_USB_VENDOR         0x046F
#define BLE_VIEWTOOL_USB_PRODUCT        0x37B3

#define BLE_VIEWTOOL_SET_MODE           0x07
#define BLE_VIEWTOOL_SET_CHANNEL        0x08
#define BLE_VIEWTOOL_OPEN_STREAM        0x09
#define BLE_VIEWTOOL_CLOSE_STREAM       0x0A

#define BLE_VIEWTOOL_CMD_MODE_AC        0x00
#define BLE_VIEWTOOL_CMD_MODE_NONE      0x04

#define BLE_VIEWTOOL_CMD_EP             0x02
#define BLE_VIEWTOOL_REP_EP             0x81
#define BLE_VIEWTOOL_PKT_EP             0x83

#define BLE_VIEWTOOL_TIMEOUT            1000

libusb_context *maincontext = NULL;

struct usb_device
{
	libusb_device_handle *dev;
	uint8_t channel;
	u_char dev_type;
	bool configured;
};

usb_device usbdev;

int find_devices()
{

    libusb_device **list = NULL;

    libusb_device *device;
    libusb_device_descriptor desc = {0};

    int rc = 0;
    int ret = 0;
    ssize_t count = 0;


    count = libusb_get_device_list(maincontext, &list);
    assert(count > 0);

    for (size_t idx = 0; idx < count; ++idx) {
        device = list[idx];
        rc = libusb_get_device_descriptor(device, &desc);
        assert(rc == 0);

        printf("Vendor:Device = %04x:%04x\n", desc.idVendor, desc.idProduct);

	if(desc.idVendor == BLE_VIEWTOOL_USB_VENDOR && desc.idProduct == BLE_VIEWTOOL_USB_PRODUCT)
	{
		printf("found device %d\n",(int)idx);
		//libusb_device_handle *dev;
		rc = libusb_open(device,&usbdev.dev);
        printf("libusb_open:%d\n",rc);
		assert(usbdev.dev != NULL);
		//set type 
		usbdev.dev_type = 1;
		usbdev.channel = 11;
		break;
	}
    }
    libusb_free_device_list(list, count);
}

int init(libusb_device_handle *dev, int channel)
{
    int rc = 0; 
   /*Check if kenel driver attached*/
/**
   printf("Check if kernel driver attached\n");
   if(libusb_kernel_driver_active(dev, 0))
   {
      printf("detach driver\n");
      rc = libusb_detach_kernel_driver(dev, 0); // detach driver
      printf("rc:%d\n",rc);
      assert(rc == 0);
   }
   printf("rc:%d\n",rc);
/**/
sleep(1);

    printf("libusb_reset_device\n");
    rc = libusb_reset_device(dev);	
    printf("libusb_reset_device rc:%d\n",rc);
    //assert(rc < 0);

sleep(1);

    //set the configurationlibusb_set_configuration
    printf("set the configuration\n");
    rc = libusb_set_configuration(dev, 1);
    //assert(rc < 0);
    printf("libusb_set_configuration rc:%d\n",rc);

sleep(1);

   printf("libusb_claim_interface\n");
   rc = libusb_claim_interface(dev, 0);
   printf("libusb_claim_interface rc:%d\n",rc);
   //assert(rc < 0);

sleep(1);
/**
    printf("libusb_set_interface_alt_setting\n");
    rc = libusb_set_interface_alt_setting(dev,0x00,0x00);	
    printf("libusb_set_interface_alt_setting rc:%d\n",rc);
    //assert(rc < 0);

sleep(1);
**/
    printf("set mode\n");
    int xfer = 0;
    unsigned char data[2];
/**
    data[0]=BLE_VIEWTOOL_SET_MODE;
    data[1]=BLE_VIEWTOOL_CMD_MODE_AC;

    rc = libusb_bulk_transfer(dev, BLE_VIEWTOOL_CMD_EP, data, sizeof(data), &xfer, BLE_VIEWTOOL_TIMEOUT);
    printf("set mode:%d xfer:%d\n",rc,xfer);
sleep(1);
**/
/**
    printf("set channel\n");
    data[0]=BLE_VIEWTOOL_SET_CHANNEL;
    data[1]=11;

    rc = libusb_bulk_transfer(dev, BLE_VIEWTOOL_CMD_EP, data, sizeof(data), &xfer, BLE_VIEWTOOL_TIMEOUT);
    printf("set channel:%d xfer:%d\n",rc,xfer);
sleep(1);
**/
/**
    //open stream
    printf("open stream\n");
    data[0]=0x03;//BLE_VIEWTOOL_OPEN_STREAM;
    rc = libusb_bulk_transfer(dev, BLE_VIEWTOOL_CMD_EP, data, sizeof(data)-1, &xfer, BLE_VIEWTOOL_TIMEOUT);
    printf("open stream:%d xfer:%d\n",rc,xfer);
sleep(1);
**/
    //read data
    unsigned char pktdata[1024];memset(pktdata,0x00,1024);
/**
    unsigned char key[36] = { 0xB2, 0xF9, 0x33, 0xD5, 0xD4, 0xB0, 0x66, 0xD7, 0x4C, 0x76,
                              0xED, 0x01, 0x00, 0x29, 0xD6, 0xBE, 0x65, 0xE3, 0x8A, 0x29,
                              0xD6, 0x14, 0xAE, 0xBA, 0x51, 0x94, 0x11, 0xE7, 0xB1, 0x14,
                              0xB2, 0xF9, 0x33, 0xD5, 0xFE, 0x66};
/**/
    unsigned char key[42] = { 0xB2, 0xF9, 0x33, 0xD5, 0xD4, 0xB0, 0x66, 0xD7, 0x11, 0x70,
                              0x56, 0x54, 0x01, 0x2C, 0xD6, 0xBE, 0x65, 0xE3, 0x8A, 0x29,
                              0xD6, 0x14, 0xAE, 0xBA, 0x51, 0x94, 0x11, 0xE7, 0xB1, 0x14,
                              0xB2, 0xF9, 0x33, 0xD5, 0xFE, 0x66, 0x77, 0xFF, 0x62, 0x58,
                              0xB8, 0x12};
//11 70 56 54
//B2 F9 33 D5 D4 B0 66 D7 99 BF 9D 14 00 2C D6 BE 65 E3 8A 29 D6 14 AE BA 51 94 11 E7 B1 14 B2 F9 33 D5 FE 66 77 FF 62 58 B8 12

    while(1)
    {
        rc = libusb_bulk_transfer(dev, BLE_VIEWTOOL_PKT_EP, pktdata, sizeof(pktdata), &xfer, BLE_VIEWTOOL_TIMEOUT);
        //printf("channel:%d ret:%d xfer:%d\n",channel,rc,xfer);
        if(xfer > 0)
        {
/**/
            for (int i = 0; i < xfer; i++)
                printf(" %02X", pktdata[i]);
            printf(" (%d)\n",xfer);
/**/
            //decrypt and print out
            for (int i = 0; i < xfer; i++)
            {
                if(i >= 10)
                {
                    if(i == 18)
                    printf(" %02X", pktdata[i] ^ pktdata[4] ^ key[i-10]);
                    else if(i == 19)
                    printf(" %02X", pktdata[i] ^ pktdata[5] ^ key[i-10]);
                    else if(i == 20)
                    printf(" %02X", pktdata[i] ^ pktdata[6] ^ key[i-10]);
                    else if(i == 21)
                    printf(" %02X", pktdata[i] ^ pktdata[7] ^ key[i-10]);
                    else
                    printf(" %02X", pktdata[i] ^ key[i-10]);
                }
                else
                printf(" %02X", pktdata[i]);
            }
            //22 and 23

            printf(" (%d)\n",xfer);
           
            memset(pktdata,0x00,1024);
        }
    //    sleep(1);
    }

    return rc;
}

int main(int argc, char *argv[])
{
/**
    unsigned char decode[42] = {0xD6,0xBE,0x89,0x8E,0x42,0x1F,0x96,0xD7,0xB5,0x30,0xD8,0x4F,0x18,0xFF,0x75,
                                0x00,0x02,0x14,0x00,0x00,0x05,0x01,0x00,0x01,0x00,0x00,0x04,0x02,0x33,0x97,
                                0x64,0x02,0x04,0x58,0x00,0x17,0x00,0x8A,0x29,0x2D,0x2A,0xA5};

    unsigned char encode[42] = {0x64,0x47,0xBA,0x5B,0x96,0xAF,0xF0,0x00,0x2C,0x8F,0x45,0x5B,0x18,0xD3,0xA3,
                                0xBE,0x67,0xF7,0x8A,0x29,0xD3,0x15,0xAE,0xBB,0x51,0x94,0x15,0xE5,0x82,0x83,
                                0xD6,0xFB,0x37,0x8D,0xFE,0x71,0x77,0x75,0x4B,0x75,0x92,0xB7};

    unsigned char xord[42];
for(int x = 0;x < 42;x++)
{
    xord[x] = encode[x] ^ decode[x];

    printf("%02X %02X %02X \n",encode[x],decode[x],xord[x]);
}

for(int x = 0;x < 42;x++)
{
    printf("%02X ",xord[x]);
}
printf("\n");
/**/

    //unsigned char decode[6] = {0x27,0xB7,0x76,0xB1,0x7C,0x43};

    unsigned char decode[45][6] = {0x00,0x54,0x84,0xAD,0x7C,0x4E,
                                0x00,0xC6,0x96,0x8E,0x7C,0x4E,
                                0x00,0x54,0xFC,0x51,0x7D,0x4E,
                                0x00,0xA1,0x92,0x33,0x7D,0x4E,
                                0x00,0x8C,0x05,0x15,0x7D,0x4E,
                                0x00,0x96,0xDF,0xF4,0x7D,0x4E,
                                0x00,0x65,0x9C,0xD4,0x7D,0x4E,
                                0x00,0x5E,0x0F,0xB6,0x7D,0x4E,
                                0x00,0xDF,0xFB,0x98,0x7D,0x4E,
                                0x00,0xB9,0xB9,0x78,0x7A,0x4E,
                                0x00,0xFB,0x13,0x59,0x7A,0x4E,
                                0x00,0xE7,0x21,0x3B,0x7A,0x4E,
                                0x00,0x40,0x21,0x1F,0x7A,0x4E,
                                0x00,0x1A,0xFF,0xFE,0x7A,0x4E,
                                0x00,0xB1,0x42,0xC2,0x7A,0x4E,
                                0x00,0x16,0xFB,0xA3,0x7A,0x4E,
                                0x00,0xE2,0x94,0x88,0x7A,0x4E,
                                0x00,0x0A,0xA7,0x6A,0x7B,0x4E,
                                0x00,0xB1,0x40,0x4F,0x7B,0x4E,
                                0x00,0xED,0xBA,0x2F,0x7B,0x4E,
                                0x00,0xAA,0x17,0xF0,0x7B,0x4E,
                                0x00,0xB2,0x86,0xD1,0x7B,0x4E,
                                0x00,0x60,0xDB,0xB3,0x7B,0x4E,
                                0x00,0x18,0xAA,0x94,0x7B,0x4E,
                                0x00,0xE3,0xFC,0x76,0x78,0x4E,
                                0x00,0xDE,0x6F,0x58,0x78,0x4E,
                                0x00,0xE6,0x63,0x39,0x78,0x4E,
                                0x00,0x46,0x8E,0x1B,0x78,0x4E,
                                0x00,0x35,0x21,0xFD,0x78,0x4E,
                                0x00,0xD2,0xEE,0xDF,0x78,0x4E,
                                0x00,0xC8,0x72,0xA3,0x78,0x4E,
                                0x00,0xBF,0x80,0x85,0x78,0x4E,
                                0x00,0x4D,0x9C,0x2E,0x79,0x4E,
                                0x00,0x6D,0x5C,0xD2,0x79,0x4E,
                                0x00,0xCF,0x63,0x95,0x79,0x4E,
                                0x00,0x00,0xDD,0x75,0x66,0x4E,
                                0x00,0x44,0x87,0x58,0x66,0x4E,
                                0x00,0x79,0xE1,0x38,0x66,0x4E,
                                0x00,0x37,0xA9,0x1B,0x66,0x4E,
                                0x00,0x35,0xBD,0xFC,0x66,0x4E,
                                0x00,0xBC,0xDF,0xDB,0x66,0x4E,
                                0x00,0x79,0xC5,0xBF,0x66,0x4E,
                                0x00,0xDE,0x38,0x80,0x66,0x4E,
                                0x00,0x28,0xD1,0x61,0x67,0x4E,
                                0x00,0x20,0x40,0x43,0x67,0x4E};
/**
    unsigned char encode[45][6] = {0x41,0x60,0xE3,0x6C,0x56,0x59,
    0x41,0x60,0xF1,0x4F,0x56,0x59,
    0x41,0x60,0x9B,0x90,0x57,0x59,
    0x41,0x60,0xF5,0xF2,0x57,0x59,
    0x41,0x60,0x62,0xD4,0x57,0x59,
    0x41,0x60,0xB8,0x35,0x57,0x59,
    0x41,0x60,0xFB,0x15,0x57,0x59,
    0x41,0x60,0x68,0x77,0x57,0x59,
    0x41,0x60,0x9C,0x59,0x57,0x59,
    0x41,0x60,0xDE,0xB9,0x50,0x59,
    0x41,0x60,0x74,0x98,0x50,0x59,
    0x41,0x60,0x46,0xFA,0x50,0x59,
    0x41,0x60,0x46,0xDE,0x50,0x59,
    0x41,0x60,0x98,0x3F,0x50,0x59,
    0x41,0x60,0x25,0x03,0x50,0x59,
    0x41,0x60,0x9C,0x62,0x50,0x59,
    0x41,0x60,0xF3,0x49,0x50,0x59,
    0x41,0x60,0xC0,0xAB,0x51,0x59,
    0x41,0x60,0x27,0x8E,0x51,0x59,
    0x41,0x60,0xDD,0xEE,0x51,0x59,
    0x41,0x60,0x70,0x31,0x51,0x59,
    0x41,0x60,0xE1,0x10,0x51,0x59,
    0x41,0x60,0xBC,0x72,0x51,0x59,
    0x41,0x60,0xCD,0x55,0x51,0x59,
    0x41,0x60,0x9B,0xB7,0x52,0x59,
    0x41,0x60,0x08,0x99,0x52,0x59,
    0x41,0x60,0x04,0xF8,0x52,0x59,
    0x41,0x60,0xE9,0xDA,0x52,0x59,
    0x41,0x60,0x46,0x3C,0x52,0x59,
    0x41,0x60,0x89,0x1E,0x52,0x59,
    0x41,0x60,0x15,0x62,0x52,0x59,
    0x41,0x60,0xE7,0x44,0x52,0x59,
    0x41,0x60,0xFB,0xEF,0x53,0x59,
    0x41,0x60,0x3B,0x13,0x53,0x59,
    0x41,0x60,0x04,0x54,0x53,0x59,
    0x41,0x60,0xBA,0xB4,0x4C,0x59,
    0x41,0x60,0xE0,0x99,0x4C,0x59,
    0x41,0x60,0x86,0xF9,0x4C,0x59,
    0x41,0x60,0xCE,0xDA,0x4C,0x59,
    0x41,0x60,0xDA,0x3D,0x4C,0x59,
    0x41,0x60,0xB8,0x1A,0x4C,0x59,
    0x41,0x60,0xA2,0x7E,0x4C,0x59,
    0x41,0x60,0x5F,0x41,0x4C,0x59,
    0x41,0x60,0xB6,0xA0,0x4D,0x59,
    0x41,0x60,0x27,0x82,0x4D,0x59};
/**/
    unsigned char encode[45][6] = {0x66,0xD7,0x95,0xDD,0x2A,0x1A,
0x66,0xD7,0x87,0xFE,0x2A,0x1A,
0x66,0xD7,0xED,0x21,0x2B,0x1A,
0x66,0xD7,0x83,0x43,0x2B,0x1A,
0x66,0xD7,0x14,0x65,0x2B,0x1A,
0x66,0xD7,0xCE,0x84,0x2B,0x1A,
0x66,0xD7,0x8D,0xA4,0x2B,0x1A,
0x66,0xD7,0x1E,0xC6,0x2B,0x1A,
0x66,0xD7,0xEA,0xE8,0x2B,0x1A,
0x66,0xD7,0xA8,0x08,0x2C,0x1A,
0x66,0xD7,0x02,0x29,0x2C,0x1A,
0x66,0xD7,0x30,0x4B,0x2C,0x1A,
0x66,0xD7,0x30,0x6F,0x2C,0x1A,
0x66,0xD7,0xEE,0x8E,0x2C,0x1A,
0x66,0xD7,0x53,0xB2,0x2C,0x1A,
0x66,0xD7,0xEA,0xD3,0x2C,0x1A,
0x66,0xD7,0x85,0xF8,0x2C,0x1A,
0x66,0xD7,0xB6,0x1A,0x2D,0x1A,
0x66,0xD7,0x51,0x3F,0x2D,0x1A,
0x66,0xD7,0xAB,0x5F,0x2D,0x1A,
0x66,0xD7,0x06,0x80,0x2D,0x1A,
0x66,0xD7,0x97,0xA1,0x2D,0x1A,
0x66,0xD7,0xCA,0xC3,0x2D,0x1A,
0x66,0xD7,0xBB,0xE4,0x2D,0x1A,
0x66,0xD7,0xED,0x06,0x2E,0x1A,
0x66,0xD7,0x7E,0x28,0x2E,0x1A,
0x66,0xD7,0x72,0x49,0x2E,0x1A,
0x66,0xD7,0x9F,0x6B,0x2E,0x1A,
0x66,0xD7,0x30,0x8D,0x2E,0x1A,
0x66,0xD7,0xFF,0xAF,0x2E,0x1A,
0x66,0xD7,0x63,0xD3,0x2E,0x1A,
0x66,0xD7,0x91,0xF5,0x2E,0x1A,
0x66,0xD7,0x8D,0x5E,0x2F,0x1A,
0x66,0xD7,0x4D,0xA2,0x2F,0x1A,
0x66,0xD7,0x72,0xE5,0x2F,0x1A,
0x66,0xD7,0xCC,0x05,0x30,0x1A,
0x66,0xD7,0x96,0x28,0x30,0x1A,
0x66,0xD7,0xF0,0x48,0x30,0x1A,
0x66,0xD7,0xB8,0x6B,0x30,0x1A,
0x66,0xD7,0xAC,0x8C,0x30,0x1A,
0x66,0xD7,0xCE,0xAB,0x30,0x1A,
0x66,0xD7,0xD4,0xCF,0x30,0x1A,
0x66,0xD7,0x29,0xF0,0x30,0x1A,
0x66,0xD7,0xC0,0x11,0x31,0x1A,
0x66,0xD7,0x51,0x33,0x31,0x1A};

/**    
    encode[0][] = {0x41,0x60,0xE3,0x6C,0x56,0x59};
    encode[1][6] = {0x41,0x60,0xF1,0x4F,0x56,0x59};
    encode[2][6] = {0x41,0x60,0x9B,0x90,0x57,0x59};
    encode[3][6] = {0x41,0x60,0xF5,0xF2,0x57,0x59};
    encode[4][6] = {0x41,0x60,0x62,0xD4,0x57,0x59};
    encode[5][6] = {0x41,0x60,0xB8,0x35,0x57,0x59};
    encode[6][6] = {0x41,0x60,0xFB,0x15,0x57,0x59};
    encode[7][6] = {0x41,0x60,0x68,0x77,0x57,0x59};
    encode[8][6] = {0x41,0x60,0x9C,0x59,0x57,0x59};
    encode[9][6] = {0x41,0x60,0xDE,0xB9,0x50,0x59};
    encode[10][6] = {0x41,0x60,0x74,0x98,0x50,0x59};
    encode[11][6] = {0x41,0x60,0x46,0xFA,0x50,0x59};
    encode[12][6] = {0x41,0x60,0x46,0xDE,0x50,0x59};
    encode[13][6] = {0x41,0x60,0x98,0x3F,0x50,0x59};
    encode[14][6] = {0x41,0x60,0x25,0x03,0x50,0x59};
    encode[15][6] = {0x41,0x60,0x9C,0x62,0x50,0x59};
    encode[16][6] = {0x41,0x60,0xF3,0x49,0x50,0x59};
    encode[17][6] = {0x41,0x60,0xC0,0xAB,0x51,0x59};
    encode[18][6] = {0x41,0x60,0x27,0x8E,0x51,0x59};
    encode[19][6] = {0x41,0x60,0xDD,0xEE,0x51,0x59};
    encode[20][6] = {0x41,0x60,0x70,0x31,0x51,0x59};
    encode[21][6] = {0x41,0x60,0xE1,0x10,0x51,0x59};
    encode[22][6] = {0x41,0x60,0xBC,0x72,0x51,0x59};
    encode[23][6] = {0x41,0x60,0xCD,0x55,0x51,0x59};
    encode[24][6] = {0x41,0x60,0x9B,0xB7,0x52,0x59};
    encode[25][6] = {0x41,0x60,0x08,0x99,0x52,0x59};
    encode[26][6] = {0x41,0x60,0x04,0xF8,0x52,0x59};
    encode[27][6] = {0x41,0x60,0xE9,0xDA,0x52,0x59};
    encode[28][6] = {0x41,0x60,0x46,0x3C,0x52,0x59};
    encode[29][6] = {0x41,0x60,0x89,0x1E,0x52,0x59};
    encode[30][6] = {0x41,0x60,0x15,0x62,0x52,0x59};
    encode[31][6] = {0x41,0x60,0xE7,0x44,0x52,0x59};
    encode[32][6] = {0x41,0x60,0xFB,0xEF,0x53,0x59};
    encode[33][6] = {0x41,0x60,0x3B,0x13,0x53,0x59};
    encode[34][6] = {0x41,0x60,0x04,0x54,0x53,0x59};
    encode[35][6] = {0x41,0x60,0xBA,0xB4,0x4C,0x59};
    encode[36][6] = {0x41,0x60,0xE0,0x99,0x4C,0x59};
    encode[37][6] = {0x41,0x60,0x86,0xF9,0x4C,0x59};
    encode[38][6] = {0x41,0x60,0xCE,0xDA,0x4C,0x59};
    encode[39][6] = {0x41,0x60,0xDA,0x3D,0x4C,0x59};
    encode[40][6] = {0x41,0x60,0xB8,0x1A,0x4C,0x59};
    encode[41][6] = {0x41,0x60,0xA2,0x7E,0x4C,0x59};
    encode[42][6] = {0x41,0x60,0x5F,0x41,0x4C,0x59};
    encode[43][6] = {0x41,0x60,0xB6,0xA0,0x4D,0x59};
    encode[44][6] = {0x41,0x60,0x27,0x82,0x4D,0x59};
**/
/**
    unsigned char xord[6];
    for(int xp=0;xp<45;xp++)
    {
        for(int x = 0;x < 6;x++)
        {
            xord[x] = encode[xp][x] ^ decode[xp][x];
            printf("%02X ",xord[x]);
        }
        printf("\n");
    }
**/
/**/
    int rc = 0;
    rc = libusb_init(&maincontext);
    assert(rc == 0);

    find_devices();

    init(usbdev.dev,11);

    libusb_exit(maincontext);
/**/
    return 0;
}
